# Kgen

Kgen is a protoc plugin for creating client libraries from protocol buffer definitions (version 3).

## Examples

You can find some examples, using Google Cloud APIs, in the [examples directory](examples/README.md).

## Getting Started

You can use Kgen with Docker or with Gradle. Using Docker is simplier in most cases, so we'll start
there, but using Gradle directly may be a better choice if you will be adding your own manually 
written code to the generated code and will be using Gradle for your project.

### Docker

The docker images for this project are coming soon, but have not yet been published. To build locally
run the following:

```bash
$ cd generator
$ ./gradlew build && docker build . -t kotlin-generator
```

Use the generator by mounting your input protocol buffers directory at `/proto` and mounting an 
output directory at `/generated`. For example:

```bash
$ mkdir example-output
$ docker run -it --rm \
         --mount type=bind,source="$(pwd)"/example-input,target=/proto \
         --mount type=bind,source="$(pwd)"/example-output,target=/generated \
         kotlin-generator
```

*Note* Until `com.google.kgax:kgax-grpc` is published you must build and publish a local
version of the library by building the kgax-grpc library and running the gradle local publish
target. Then, copy your ~/.m2/repository to `generator/repository`. This will be removed soon!

### Gradle

  1. Write your API using proto3 as described in the [Language Guide](https://developers.google.com/protocol-buffers/docs/proto).
  2. Put all of your `.proto` files in `app/src/main/proto` (Android) or `src/main/proto` (non-Android).
  3. Configure your application's `build.gradle` as shown below:
  
      *Note* the following example is for an Android application, but the process is nearly 
      identical for a standalone Kotlin application.
      
      ```groovy
      plugins {
          id "com.google.protobuf" version "0.8.5"
      }
      
      // or the java plugin if your not making an Android app
      apply plugin: 'com.android.application'
      apply plugin: 'kotlin-android'
      apply plugin: 'kotlin-android-extensions'
      
      dependencies {
          // ...
          
          // for http/2 gRPC based clients (recommended)
          implementation 'com.google.kgax:kgax-grpc:0.1.0'
          
          // if you prefer to use http/1 use this instead (coming soon)
          // implementation ...
      }
      
      // compile proto and generate your client library
      protobuf {
          // set the version of protobuf compiler to use
          protoc {
              artifact = 'com.google.protobuf:protoc:3.6.0'
          }
          // set the version of the code generators to use
          plugins {
              javalite {
                  artifact = 'com.google.protobuf:protoc-gen-javalite:3.0.0'
              }
              grpc {
                  artifact = 'io.grpc:protoc-gen-grpc-java:1.10.0'
              }
              client {
                  artifact = 'com.google.api:kotlin-client-generator:0.1.0:core@jar'
              }
          }
          // run the code generators
          generateProtoTasks {
              all().each { task ->
                  task.builtins {
                      // java artifacts are generated by default, so delete them
                      // the 'javalite' plugin will generate the files we need instead
                      remove java
                  }
                  task.plugins {
                      // this generates the protocol buffer message types
                      // which include the inputs and outputs of your API
                      javalite {}
                      // this generates a low-level gRPC client for the service defined in your API
                      grpc {
                          option 'lite'
                      }
                      // this generates your client library!
                      client {
                          // TODO: these options will change
                          // for now we have to tell the plugin where the protos are
                          option "source_directory=${projectDir}/src/main/proto"
                      }
                  }
              }
          }
      }
      ```
      
  4. Build your application with gradle:
        
        ```bash
              $ ./gradlew build
        ```

  5. Enjoy your new client library! The generated source code will available on the classpath
     for your application to use, and you can find it at `app/build/generated/source/proto`
     (Android) or `build/generated/source/proto` (standalone application).
     
## Code Formatting

This project uses dockerized versions of Intellij CE's code formatter,
[Google Java Format](https://github.com/google/google-java-format) and [ktlint](https://ktlint.github.io/). 
They can be customized for the generator and they can be used standalone.

### Building

```
  $ docker build --target formatter . -t formatter
  $ docker build --target javaformatter . -t javaformatter
  $ docker build --target ktlint . -t ktlint
```

### Usage

Run the container and mount the directory that contains the source files that you want to 
format to `/src` inside the container. It will format all files recursively using the rules defined 
in `format.xml`. For example, to format the files in the current directory use:

```
  $ docker run --rm -it -v $PWD:/src formatter
  $ docker run --rm -it -v $PWD:/src javaformatter
  $ docker run --rm -it -v $PWD:/src ktlint
```

### Customizing

You can replace `/usr/ide/format.xml` with your own formatter configuration to customize
the settings for the intelliJ formatter. See the official [documentation](https://www.jetbrains.com/help/idea/settings-code-style.html)
for more details.

Alternatively, you may override the defaults for any of the formatters by passing arguments to the commands. 
See the `Dockerfile` for the default set of arugments.

### Why So Many Formatters

ktlint does not currently fix long lines so the Intellij formatter is being used for now. This is likely 
to change at some point so we are experimenting with the various options that are available.

## Contributing

Contributions to this library are always welcome and highly encouraged.

See the [CONTRIBUTING](CONTRIBUTING.md) documentation for more information on how to get started.

## Versioning

This library is currently a *preview* with no guarantees of stability or support. Please get involved and let us know
if you find it useful and we'll work towards a stable version.

## Disclaimer

This is not an official Google product.
